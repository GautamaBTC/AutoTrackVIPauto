<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ñ—É—Ä–Ω–∞–ª —Ä–∞–±–æ—Ç –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-color: #007bff; --primary-dark: #0056b3; --success-color: #28a745; --warning-color: #ffc107; --light-gray: #f4f7f6; --dark-text: #1a2533; --light-text: #333; --danger-color: #dc3545; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: var(--light-gray); color: var(--light-text); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }
        .view-switcher { text-align: right; margin-bottom: 20px; }
        .view-switcher button { background-color: #e9ecef; border: 1px solid #ccc; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
        h1, h2 { color: var(--dark-text); border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        #form-header-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        input, select { padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; width: 100%; box-sizing: border-box; }
        .form-buttons { display: flex; flex-wrap: wrap; gap: 10px; grid-column: 1 / -1; }
        .form-buttons button { flex-grow: 1; padding: 15px; font-size: 18px; font-weight: 600; color: #fff; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; min-width: 150px; }
        #submit-button { background: linear-gradient(45deg, var(--primary-color), var(--primary-dark)); }
        #cancel-edit-button { background-color: #6c757d; display: none; }
        #clear-form-long-press-btn { position: relative; background: #e9ecef; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #clear-form-long-press-btn svg { width: 20px; height: 20px; fill: #6c757d; z-index: 2; }
        #clear-form-long-press-btn .progress-fill { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--danger-color); transform: scaleX(0); transform-origin: left; z-index: 1; }
        #clear-form-long-press-btn.clearing .progress-fill { transform: scaleX(1); transition: transform 1.5s linear; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-window { background: #fff; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); max-width: 600px; width: 90%; transform: scale(0.9); transition: transform 0.3s; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-overlay.active .modal-window { transform: scale(1); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; }
        .modal-header h3 { margin: 0; }
        .modal-header input { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .modal-body { overflow-y: auto; padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button { padding: 10px 20px; border-radius: 6px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
        #modal-confirm-btn { background-color: var(--success-color); color: white; }
        #modal-cancel-btn { background-color: #ccc; }
        .service-category h4 { margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .service-item { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; }
        .service-item input[type="checkbox"] { margin-right: 10px; width: 20px; height: 20px; }
        #service-display-field { background-color: #e9ecef; border: 1px solid #ccc; padding: 12px; border-radius: 6px; min-height: 48px; color: #6c757d; cursor: pointer; }
        #service-display-field.has-content { color: var(--dark-text); white-space: pre-wrap; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .summary-card { background-color: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 5px solid var(--primary-color); }
        .summary-card h3 { margin-top: 0; font-size: 16px; }
        .summary-card p { font-size: 28px; font-weight: 700; margin: 10px 0 0 0; }
        .summary-card.service { border-color: var(--success-color); } .summary-card.service p { color: var(--success-color); }
        .accordion { border-color: var(--warning-color); padding: 0; }
        .accordion .accordion-header { padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion .header-content { flex-grow: 1; } .accordion .header-content p { color: #c69500; }
        .accordion .accordion-icon { font-size: 24px; font-weight: bold; transition: transform 0.3s ease; }
        .accordion.active .accordion-icon { transform: rotate(180deg); }
        .accordion .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; border-top: 1px solid #e0e0e0; padding: 0 20px; }
        .accordion.active .accordion-content { max-height: 1000px; padding: 20px; }
        .master-detail-item { padding: 15px 0; border-bottom: 1px solid #eee; } .master-detail-item:last-child { border-bottom: none; }
        .master-main-info { display: flex; justify-content: space-between; font-size: 16px; margin-bottom: 10px; }
        .master-main-info .master-name { font-weight: bold; }
        .master-bonus-controls { display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: center; margin-top: 10px; }
        .bonus-slider { width: 100%; }
        .master-total-payout { margin-top: 15px; text-align: right; font-size: 18px; font-weight: bold; color: var(--success-color); }
        .master-total-payout span { font-weight: normal; }
        #date-selector-wrapper { margin-bottom: 20px; text-align: center; } #date-selector-wrapper label { margin-right: 10px; font-size: 18px; font-weight: 600; } #date-selector { padding: 8px; font-size: 16px; }
        .master-log-accordion { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; }
        .master-log-header { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; background-color: #f8f9fa; }
        .master-log-header h4 { margin: 0; font-size: 18px; }
        .master-log-summary { margin-left: auto; padding: 0 20px; text-align: right; }
        .master-log-summary span { display: block; font-size: 14px; }
        .master-log-summary strong { color: var(--dark-text); }
        .master-log-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .master-log-accordion.active .master-log-content { max-height: 1500px; }
        .master-log-accordion.active .accordion-icon { transform: rotate(180deg); }
        .master-log-content table { margin-top: 0; width: 100%; border-collapse: collapse; }
        .master-log-content th, .master-log-content td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .actions-cell { text-align: right !important; } .action-btn { background: none; border: none; cursor: pointer; padding: 5px; } .action-btn svg { width: 20px; height: 20px; } .action-btn.edit-btn svg { fill: var(--primary-color); } .action-btn.delete-btn svg { fill: var(--danger-color); }
        .analytics-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background-color: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; }
        .kpi-card h4 { margin: 0 0 10px 0; color: #6c757d; font-size: 14px; text-transform: uppercase; }
        .kpi-card p { margin: 0; font-size: 26px; font-weight: 700; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .chart-container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        @media screen and (max-width: 992px) { .charts-grid { grid-template-columns: 1fr; } }
        @media screen and (max-width: 768px) { body { padding: 10px; } .container { padding: 15px; } .master-log-header { flex-direction: column; align-items: flex-start; } .master-log-summary { margin-left: 0; margin-top: 10px; text-align: left; padding: 0; } .master-log-content thead { display: none; } .master-log-content tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; } .master-log-content td { display: block; text-align: right; border-bottom: 1px dotted #ccc; position: relative; padding-left: 50%; } .master-log-content td:last-child { border-bottom: 0; } .master-log-content td::before { content: attr(data-label); position: absolute; left: 10px; width: calc(50% - 20px); text-align: left; font-weight: bold; } .actions-cell { text-align: center !important; padding-left: 15px !important; } .actions-cell::before { display: none; } }
    </style>
</head>
<body>

<div class="container">
    <!-- –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∞ –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç... -->
    <div class="view-switcher">
        <button id="switch-to-analytics-btn">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        <button id="switch-to-log-btn" class="hidden">üìã –ö –∂—É—Ä–Ω–∞–ª—É</button>
    </div>

    <div id="log-view">
        <h1>–ñ—É—Ä–Ω–∞–ª —Ä–∞–±–æ—Ç –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–∞</h1>
        <div id="date-selector-wrapper"><label for="date-selector">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á–µ—Ç –∑–∞:</label><input type="date" id="date-selector"></div>
        <div id="form-header-wrapper"><h2 id="form-header">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å</h2><button id="clear-form-long-press-btn" title="–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ, —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É"><svg viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg><span class="progress-fill"></span></button></div>
        <form id="add-entry-form">
             <div class="form-grid">
                <div class="form-group"><label for="master">–ú–∞—Å—Ç–µ—Ä</label><select id="master" required><option value="–í–ª–∞–¥–∏–º–∏—Ä –ê.">–í–ª–∞–¥–∏–º–∏—Ä –ê.</option><option value="–í–ª–∞–¥–∏–º–∏—Ä">–í–ª–∞–¥–∏–º–∏—Ä</option><option value="–ê–Ω–¥—Ä–µ–π">–ê–Ω–¥—Ä–µ–π</option><option value="–î–∞–Ω–∏–ª–∞">–î–∞–Ω–∏–ª–∞</option><option value="–ú–∞–∫—Å–∏–º">–ú–∞–∫—Å–∏–º</option><option value="–ê—Ä—Ç—ë–º">–ê—Ä—Ç—ë–º</option></select></div>
                <div class="form-group"><label for="car">–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å</label><input type="text" id="car" list="car-datalist" placeholder="–ù–∞–ø—Ä. Kia Rio" required><datalist id="car-datalist"></datalist></div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</label>
                    <div id="service-display-field" role="button" tabindex="0">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥–∏...</div>
                </div>
                <div class="form-group"><label for="work-cost">–°—É–º–º–∞ –∑–∞ —Ä–∞–±–æ—Ç—É (—Ä—É–±.)</label><input type="number" id="work-cost" min="0" value="0" required></div>
                <div class="form-group"><label for="parts-markup">–ù–∞–∫—Ä—É—Ç–∫–∞ –∑–∞ –∑–∞–ø—á–∞—Å—Ç–∏ (—Ä—É–±.)</label><input type="number" id="parts-markup" min="0" value="0" required></div>
            </div>
            <div class="form-buttons">
                <button type="submit" id="submit-button">–î–æ–±–∞–≤–∏—Ç—å –≤ –∂—É—Ä–Ω–∞–ª</button>
                <button type="button" id="cancel-edit-button">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
        <h2 id="summary-title">–ò—Ç–æ–≥–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
        <div class="summary-grid">
            <div class="summary-card"><h3 >–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</h3><p id="total-revenue">0.00 —Ä—É–±.</p></div>
            <div class="summary-card service"><h3>–î–æ–ª—è —Å–µ—Ä–≤–∏—Å–∞ (50%)</h3><p id="service-share">0.00 —Ä—É–±.</p></div>
            <div class="summary-card accordion" id="masters-accordion"><div class="accordion-header"><div class="header-content"><h3>–ó–∞—Ä–ø–ª–∞—Ç–Ω–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å</h3><p id="masters-share-total">0.00 —Ä—É–±.</p></div><span class="accordion-icon">‚ñº</span></div><div class="accordion-content" id="masters-details"></div></div>
        </div>
        <h2 id="log-title">–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —Ä–∞–±–æ—Ç—ã</h2>
        <div id="daily-log-accordions"></div>
    </div>

    <div id="analytics-view" class="hidden">
        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
        <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –û—Ç—á–µ—Ç—ã</h1>
        <div class="analytics-controls">
            <label for="period-select">–ü–µ—Ä–∏–æ–¥:</label>
            <select id="period-select">
                <option value="this_week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
                <option value="last_week">–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è</option>
                <option value="this_month" selected>–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
                <option value="last_month">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</option>
                <option value="custom">–°–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω</option>
            </select>
            <div id="custom-period-inputs" class="hidden">
                <label for="start-date">—Å</label>
                <input type="date" id="start-date">
                <label for="end-date">–ø–æ</label>
                <input type="date" id="end-date">
                <button id="apply-custom-period">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
            <button id="export-csv-btn">–°–∫–∞—á–∞—Ç—å CSV</button>
        </div>
        <div class="kpi-grid">
            <div class="kpi-card"><h4>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</h4><p id="kpi-revenue">0</p></div>
            <div class="kpi-card"><h4>–ü—Ä–∏–±—ã–ª—å —Å–µ—Ä–≤–∏—Å–∞</h4><p id="kpi-profit">0</p></div>
            <div class="kpi-card"><h4>–í—ã–ø–ª–∞—Ç—ã –º–∞—Å—Ç–µ—Ä–∞–º</h4><p id="kpi-payout">0</p></div>
            <div class="kpi-card"><h4>–ö–æ–ª-–≤–æ —Ä–∞–±–æ—Ç</h4><p id="kpi-jobs">0</p></div>
        </div>
        <div class="charts-grid">
            <div class="chart-container"><h3>–í—ã—Ä—É—á–∫–∞ –ø–æ –¥–Ω—è–º</h3><canvas id="revenue-by-day-chart"></canvas></div>
            <div class="chart-container"><h3>–í–∫–ª–∞–¥ –º–∞—Å—Ç–µ—Ä–æ–≤</h3><canvas id="masters-contribution-chart"></canvas></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="services-modal">
    <div class="modal-window">
        <div class="modal-header">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏</h3>
            <input type="search" id="service-search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —É—Å–ª—É–≥–∞–º...">
        </div>
        <div class="modal-body" id="service-list-container"></div>
        <div class="modal-footer">
            <button id="modal-cancel-btn">–û—Ç–º–µ–Ω–∞</button>
            <button id="modal-confirm-btn">–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- –°–ü–†–ê–í–û–ß–ù–ò–ö –£–°–õ–£–ì ---
    const servicesCatalog = {
        "–ê–≤—Ç–æ—ç–ª–µ–∫—Ç—Ä–∏–∫–∞ –∏ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": ["–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≠–ë–£", "–ü–æ–∏—Å–∫ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä—ã–≤–∞ –ø—Ä–æ–≤–æ–¥–∫–∏", "–†–µ–º–æ–Ω—Ç —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–∫–∏", "–†–µ–º–æ–Ω—Ç —Å—Ç–∞—Ä—Ç–µ—Ä–∞", "–†–µ–º–æ–Ω—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞", "–ó–∞–º–µ–Ω–∞ –±–ª–æ–∫–∞ –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª–µ–π", "–ó–∞–º–µ–Ω–∞ –¥–∞—Ç—á–∏–∫–∞ (ABS, –∫–æ–ª–µ–Ω–≤–∞–ª–∞ –∏ —Ç.–¥.)", "–†–µ–º–æ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã –∑–∞–∂–∏–≥–∞–Ω–∏—è", "–†–µ–º–æ–Ω—Ç —Å—Ç–µ–∫–ª–æ–ø–æ–¥—ä–µ–º–Ω–∏–∫–∞", "–†–µ–º–æ–Ω—Ç —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–º–∫–∞", "–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏–º–º–æ–±–∏–ª–∞–π–∑–µ—Ä–∞", "–ü—Ä–æ–ø–∏—Å–∫–∞ –∫–ª—é—á–µ–π", "–†–µ–º–æ–Ω—Ç —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ Start/Stop", "–ü—Ä–µ–¥–ø—Ä–æ–¥–∞–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç–ª–µ–∫—Ç—Ä–∏–∫–∏"],
        "–ê–≤—Ç–æ—Å–≤–µ—Ç": ["–†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Å–≤–µ—Ç–∞ —Ñ–∞—Ä", "–ó–∞–º–µ–Ω–∞ –ª–∞–º–ø (–≥–∞–ª–æ–≥–µ–Ω, –∫—Å–µ–Ω–æ–Ω, LED)", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—Å–µ–Ω–æ–Ω–∞ / LED –ª–∏–Ω–∑", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ç—É–º–∞–Ω–Ω—ã—Ö —Ñ–∞—Ä (–ü–¢–§)", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–Ω–µ–≤–Ω—ã—Ö —Ö–æ–¥–æ–≤—ã—Ö –æ–≥–Ω–µ–π (–î–•–û)", "–†–µ–º–æ–Ω—Ç —Ñ–∞—Ä / —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø–æ—Ç–µ–≤–∞–Ω–∏—è", "–ü–æ–ª–∏—Ä–æ–≤–∫–∞ —Ñ–∞—Ä", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–∞–ª–æ–Ω–∞/–¥–≤–µ—Ä–µ–π", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –¥–Ω–∏—â–∞", "–ó–∞–º–µ–Ω–∞ –∑–∞–¥–Ω–∏—Ö —Ñ–æ–Ω–∞—Ä–µ–π"],
        "–û—Ö—Ä–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã": ["–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (–±–∞–∑–æ–≤–∞—è)", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —Å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–º", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ —Å GSM/GPS", "–î–µ–º–æ–Ω—Ç–∞–∂ —Å—Ç–∞—Ä–æ–π —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–º–º–æ–±–∏–ª–∞–π–∑–µ—Ä–∞", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ GPS-—Ç—Ä–µ–∫–µ—Ä–∞ / –º–∞—è–∫–∞", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–∏—Ä–∞—Ç–æ—Ä–æ–≤ (–ö–ü–ü, —Ä—É–ª—å)", "–ù–∞—Å—Ç—Ä–æ–π–∫–∞/–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–µ–ª–æ–∫–∞", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –∫–Ω–æ–ø–∫–∏", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—á–∏–∫–∞ –æ–±—ä–µ–º–∞/—É–¥–∞—Ä–∞"],
        "–ê—É–¥–∏–æ- –∏ –í–∏–¥–µ–æ—Å–∏—Å—Ç–µ–º—ã": ["–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞–≥–Ω–∏—Ç–æ–ª—ã 1DIN / 2DIN", "–ó–∞–º–µ–Ω–∞ —à—Ç–∞—Ç–Ω–æ–π –∞–∫—É—Å—Ç–∏–∫–∏", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–∏–ª–∏—Ç–µ–ª—è –∑–≤—É–∫–∞", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∞–±–≤—É—Ñ–µ—Ä–∞", "–ü—Ä–æ–∫–ª–∞–¥–∫–∞ –∞–∫—É—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–≤–æ–¥–æ–≤", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞", "–®—É–º–æ–∏–∑–æ–ª—è—Ü–∏—è –¥–≤–µ—Ä–µ–π –ø–æ–¥ –º—É–∑—ã–∫—É", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (1 –∫–∞–º–µ—Ä–∞)", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (2 –∫–∞–º–µ—Ä—ã, —Å–∫—Ä—ã—Ç–∞—è –ø—Ä–æ–≤–æ–¥–∫–∞)", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã –∑–∞–¥–Ω–µ–≥–æ –≤–∏–¥–∞", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã –ø–µ—Ä–µ–¥–Ω–µ–≥–æ –≤–∏–¥–∞", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∫—Ä—É–≥–æ–≤–æ–≥–æ –æ–±–∑–æ—Ä–∞ (360¬∞)", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–ª–æ—á–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∞", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–æ–≤ –≤ –ø–æ–¥–≥–æ–ª–æ–≤–Ω–∏–∫–∏", "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–¥–∏–æ—Å–∏—Å—Ç–µ–º—ã"],
        "–ö–æ–º—Ñ–æ—Ä—Ç –∏ –î–æ–ø. –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": ["–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–∫—Ç—Ä–æ–Ω–∏–∫–æ–≤ (–∑–∞–¥–Ω–∏–π –±–∞–º–ø–µ—Ä)", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–∫—Ç—Ä–æ–Ω–∏–∫–æ–≤ (–ø–µ—Ä–µ–¥–Ω–∏–π –±–∞–º–ø–µ—Ä)", "–ó–∞–ø—Ä–∞–≤–∫–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞", "–ê–Ω—Ç–∏–±–∞–∫—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–æ–≥—Ä–µ–≤–∞ —Å–∏–¥–µ–Ω–∏–π", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–æ–≥—Ä–µ–≤–∞ —Ä—É–ª—è", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–æ–≥—Ä–µ–≤–∞ –∑–µ—Ä–∫–∞–ª/—Å—Ç–µ–∫–æ–ª", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–≤–æ–¥–∞ –±–∞–≥–∞–∂–Ω–∏–∫–∞", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–¥–æ–≤–æ–¥—á–∏–∫–æ–≤ –¥–≤–µ—Ä–µ–π", "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∞—Ä–∫–æ–ø–∞"],
        "–¢–æ–Ω–∏—Ä–æ–≤–∫–∞": ["–¢–æ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–¥–Ω–µ–π –ø–æ–ª—É—Å—Ñ–µ—Ä—ã", "–¢–æ–Ω–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ–¥–Ω–∏—Ö —Å—Ç–µ–∫–æ–ª", "–¢–æ–Ω–∏—Ä–æ–≤–∫–∞ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞", "–ê—Ç–µ—Ä–º–∞–ª—å–Ω–∞—è —Ç–æ–Ω–∏—Ä–æ–≤–∫–∞", "–†–∞—Å—Ç–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–µ–∫–æ–ª"]
    };

    // --- –≠–õ–ï–ú–ï–ù–¢–´ ---
    const switchToAnalyticsBtn = document.getElementById('switch-to-analytics-btn');
    const switchToLogBtn = document.getElementById('switch-to-log-btn');
    const logView = document.getElementById('log-view');
    const analyticsView = document.getElementById('analytics-view');
    const periodSelect = document.getElementById('period-select');
    const customPeriodInputs = document.getElementById('custom-period-inputs');
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const applyCustomPeriodBtn = document.getElementById('apply-custom-period');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const kpiRevenue = document.getElementById('kpi-revenue');
    const kpiProfit = document.getElementById('kpi-profit');
    const kpiPayout = document.getElementById('kpi-payout');
    const kpiJobs = document.getElementById('kpi-jobs');
    const revenueChartCtx = document.getElementById('revenue-by-day-chart').getContext('2d');
    const mastersChartCtx = document.getElementById('masters-contribution-chart').getContext('2d');
    let revenueChart, mastersChart;
    const form = document.getElementById('add-entry-form');
    const clearFormBtn = document.getElementById('clear-form-long-press-btn');
    const formHeader = document.getElementById('form-header');
    const submitButton = document.getElementById('submit-button');
    const cancelEditButton = document.getElementById('cancel-edit-button');
    const carInput = document.getElementById('car');
    const carDatalist = document.getElementById('car-datalist');
    const serviceDisplayField = document.getElementById('service-display-field');
    const servicesModal = document.getElementById('services-modal');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const serviceSearchInput = document.getElementById('service-search-input');
    const serviceListContainer = document.getElementById('service-list-container');
    const dateSelector = document.getElementById('date-selector');
    const dailyLogAccordions = document.getElementById('daily-log-accordions');
    const totalRevenueEl = document.getElementById('total-revenue');
    const serviceShareEl = document.getElementById('service-share');
    const mastersAccordion = document.getElementById('masters-accordion');
    const mastersShareTotalEl = document.getElementById('masters-share-total');
    const mastersDetailsEl = document.getElementById('masters-details');
    const summaryTitle = document.getElementById('summary-title');
    const logTitle = document.getElementById('log-title');
    let allEntries = [];
    let allBonuses = {};
    let editMode = false;
    let entryToEditId = null;
    let tempSelectedServices = [];
    const STORAGE_KEY_ENTRIES = 'autoServiceLog_entries_v4';
    const STORAGE_KEY_BONUSES = 'autoServiceLog_bonuses_v4';
    let clearTimer = null;

    const today = new Date().toISOString().slice(0, 10);
    dateSelector.value = today;
    loadFromStorage();
    populateCarDatalist();
    displayDataForSelectedDate();
    
    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
    serviceDisplayField.addEventListener('click', openServicesModal);
    modalCancelBtn.addEventListener('click', closeServicesModal);
    modalConfirmBtn.addEventListener('click', confirmServiceSelection);
    serviceSearchInput.addEventListener('input', () => renderServiceList(serviceSearchInput.value));
    switchToAnalyticsBtn.addEventListener('click', () => { logView.classList.add('hidden'); analyticsView.classList.remove('hidden'); switchToAnalyticsBtn.classList.add('hidden'); switchToLogBtn.classList.remove('hidden'); generateAnalytics(); });
    switchToLogBtn.addEventListener('click', () => { analyticsView.classList.add('hidden'); logView.classList.remove('hidden'); switchToLogBtn.classList.add('hidden'); switchToAnalyticsBtn.classList.remove('hidden'); });
    periodSelect.addEventListener('change', () => { customPeriodInputs.classList.toggle('hidden', periodSelect.value !== 'custom'); if (periodSelect.value !== 'custom') generateAnalytics(); });
    applyCustomPeriodBtn.addEventListener('click', generateAnalytics);
    exportCsvBtn.addEventListener('click', exportToCsv);
    form.addEventListener('submit', handleFormSubmit);
    dateSelector.addEventListener('change', displayDataForSelectedDate);
    cancelEditButton.addEventListener('click', cancelEditMode);
    mastersAccordion.querySelector('.accordion-header').addEventListener('click', () => mastersAccordion.classList.toggle('active'));
    const startClearing = (e) => { e.preventDefault(); if (editMode) return; clearFormBtn.classList.add('clearing'); clearTimer = setTimeout(() => { resetForm(); resetClearButton(); }, 1500); };
    const stopClearing = () => { clearTimeout(clearTimer); resetClearButton(); };
    const resetClearButton = () => { clearFormBtn.classList.remove('clearing'); };
    clearFormBtn.addEventListener('mousedown', startClearing); clearFormBtn.addEventListener('mouseup', stopClearing); clearFormBtn.addEventListener('mouseleave', stopClearing);
    clearFormBtn.addEventListener('touchstart', startClearing); clearFormBtn.addEventListener('touchend', stopClearing);

    // --- –õ–û–ì–ò–ö–ê –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –£–°–õ–£–ì ---
    function openServicesModal() {
        const currentServices = serviceDisplayField.dataset.services ? JSON.parse(serviceDisplayField.dataset.services) : [];
        tempSelectedServices = [...currentServices];
        renderServiceList();
        updateModalConfirmButton();
        servicesModal.classList.add('active');
        serviceSearchInput.focus();
    }
    function closeServicesModal() { servicesModal.classList.remove('active'); }
    function renderServiceList(searchTerm = '') {
        serviceListContainer.innerHTML = '';
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        for (const category in servicesCatalog) {
            const filteredServices = servicesCatalog[category].filter(service => service.toLowerCase().includes(lowerCaseSearchTerm));
            if (filteredServices.length > 0) {
                const categoryEl = document.createElement('div');
                categoryEl.className = 'service-category';
                let servicesHTML = `<h4>${category}</h4>`;
                filteredServices.forEach(service => {
                    const isChecked = tempSelectedServices.includes(service) ? 'checked' : '';
                    servicesHTML += `<label class="service-item"><input type="checkbox" value="${service}" ${isChecked}><span>${service}</span></label>`;
                });
                categoryEl.innerHTML = servicesHTML;
                serviceListContainer.appendChild(categoryEl);
            }
        }
        serviceListContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                if (e.target.checked) { tempSelectedServices.push(e.target.value); } 
                else { tempSelectedServices = tempSelectedServices.filter(s => s !== e.target.value); }
                updateModalConfirmButton();
            });
        });
    }
    function updateModalConfirmButton() {
        const count = tempSelectedServices.length;
        modalConfirmBtn.textContent = `–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (${count})`;
        modalConfirmBtn.disabled = count === 0;
    }
    function confirmServiceSelection() {
        if (tempSelectedServices.length > 0) {
            serviceDisplayField.textContent = tempSelectedServices.join(', ');
            serviceDisplayField.dataset.services = JSON.stringify(tempSelectedServices);
            serviceDisplayField.classList.add('has-content');
        } else {
            resetServiceField();
        }
        closeServicesModal();
    }

    // --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function handleFormSubmit(event) {
        event.preventDefault();
        const selectedServices = serviceDisplayField.dataset.services ? JSON.parse(serviceDisplayField.dataset.services) : [];
        if (selectedServices.length === 0) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É.'); return; }
        const entryData = { date: dateSelector.value, master: document.getElementById('master').value, car: carInput.value, description: selectedServices.join(', '), workCost: parseFloat(document.getElementById('work-cost').value) || 0, partsMarkup: parseFloat(document.getElementById('parts-markup').value) || 0 };
        if (editMode) {
            const index = allEntries.findIndex(e => e.id === entryToEditId);
            if (index !== -1) allEntries[index] = { ...allEntries[index], ...entryData };
        } else {
            allEntries.push({ id: Date.now(), ...entryData });
        }
        saveToStorage(); populateCarDatalist(); displayDataForSelectedDate(); resetForm(); document.getElementById('master').focus();
    }
    function startEditMode(id) {
        editMode = true; entryToEditId = id;
        const entry = allEntries.find(e => e.id === id);
        if (!entry) return;
        document.getElementById('master').value = entry.master;
        carInput.value = entry.car;
        document.getElementById('work-cost').value = entry.workCost;
        document.getElementById('parts-markup').value = entry.partsMarkup;
        const services = entry.description.split(', ');
        serviceDisplayField.textContent = entry.description;
        serviceDisplayField.dataset.services = JSON.stringify(services);
        serviceDisplayField.classList.add('has-content');
        formHeader.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏";
        submitButton.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
        cancelEditButton.style.display = 'block';
        window.scrollTo(0, 0);
    }
    function cancelEditMode() {
        editMode = false; entryToEditId = null;
        resetForm();
        formHeader.textContent = "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å";
        submitButton.textContent = "–î–æ–±–∞–≤–∏—Ç—å –≤ –∂—É—Ä–Ω–∞–ª";
        cancelEditButton.style.display = 'none';
    }
    function deleteEntry(id) { if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) { allEntries = allEntries.filter(e => e.id !== id); saveToStorage(); displayDataForSelectedDate(); populateCarDatalist(); } }
    function resetForm() { form.reset(); resetServiceField(); }
    function resetServiceField() { serviceDisplayField.textContent = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥–∏...'; serviceDisplayField.dataset.services = '[]'; serviceDisplayField.classList.remove('has-content'); }
    function populateCarDatalist() { const uniqueCars = [...new Set(allEntries.map(e => e.car))].sort(); carDatalist.innerHTML = uniqueCars.map(car => `<option value="${car}"></option>`).join(''); }
    // --- –î–∏—Å–ø–ª–µ–π –∏ —Ä–∞—Å—á–µ—Ç—ã --- (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    function displayDataForSelectedDate() { const selectedDate = dateSelector.value; const entriesForDay = allEntries.filter(entry => entry.date === selectedDate); const isToday = new Date(selectedDate).toDateString() === new Date().toDateString(); const dateFormatted = new Date(selectedDate).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' }); summaryTitle.textContent = isToday ? '–ò—Ç–æ–≥–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è' : `–ò—Ç–æ–≥–∏ –∑–∞ ${dateFormatted}`; logTitle.textContent = isToday ? '–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —Ä–∞–±–æ—Ç—ã' : `–†–∞–±–æ—Ç—ã –∑–∞ ${dateFormatted}`; dailyLogAccordions.innerHTML = ''; if (entriesForDay.length === 0) { dailyLogAccordions.innerHTML = `<p style="text-align:center; color: #888; padding: 20px;">–ó–∞–ø–∏—Å–µ–π –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç.</p>`; updateTotalsAndBonuses({}, 0); return; } const groupedByMaster = entriesForDay.reduce((acc, entry) => { (acc[entry.master] = acc[entry.master] || []).push(entry); return acc; }, {}); let mastersEarnings = {}; let totalRevenue = 0; Object.keys(groupedByMaster).sort().forEach(master => { const masterEntries = groupedByMaster[master]; const masterRevenue = masterEntries.reduce((sum, e) => sum + e.workCost + e.partsMarkup, 0); totalRevenue += masterRevenue; mastersEarnings[master] = masterRevenue * 0.5; createMasterLogAccordion(master, masterEntries, masterRevenue); }); updateTotalsAndBonuses(mastersEarnings, totalRevenue); }
    function createMasterLogAccordion(master, entries, revenue) { const accordionEl = document.createElement('div'); accordionEl.className = 'master-log-accordion'; let tableRows = ''; entries.forEach(entry => { const totalEntrySum = entry.workCost + entry.partsMarkup; tableRows += `<tr data-id="${entry.id}"><td data-label="–ê–≤—Ç–æ–º–æ–±–∏–ª—å">${entry.car}</td><td data-label="–û–ø–∏—Å–∞–Ω–∏–µ">${entry.description}</td><td data-label="–†–∞–±–æ—Ç–∞">${entry.workCost.toFixed(2)}</td><td data-label="–ù–∞–∫—Ä—É—Ç–∫–∞">${entry.partsMarkup.toFixed(2)}</td><td data-label="–ò—Ç–æ–≥–æ"><strong>${totalEntrySum.toFixed(2)}</strong></td><td class="actions-cell"><button class="action-btn edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><svg viewBox="0 0 24 24"><path d="M17.25,2.82L21.18,6.75L19.25,8.68L15.32,4.75M4,14V18H8L18.5,7.5L14.5,3.5L4,14M4,20H20V22H4V20Z"></path></svg></button><button class="action-btn delete-btn" title="–£–¥–∞–ª–∏—Ç—å"><svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"></path></svg></button></td></tr>`; }); accordionEl.innerHTML = `<div class="master-log-header"><h4>${master}</h4><div class="master-log-summary"><span>–†–∞–±–æ—Ç: <strong>${entries.length}</strong></span><span>–í—ã—Ä—É—á–∫–∞: <strong>${revenue.toFixed(2)} ‚ÇΩ</strong></span></div><span class="accordion-icon">‚ñº</span></div><div class="master-log-content"><table><thead><tr><th>–ê–≤—Ç–æ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–†–∞–±–æ—Ç–∞</th><th>–ù–∞–∫—Ä—É—Ç–∫–∞</th><th>–ò—Ç–æ–≥–æ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>${tableRows}</tbody></table></div>`; dailyLogAccordions.appendChild(accordionEl); accordionEl.querySelector('.master-log-header').addEventListener('click', () => accordionEl.classList.toggle('active')); accordionEl.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); startEditMode(parseInt(btn.closest('tr').dataset.id)); })); accordionEl.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); deleteEntry(parseInt(btn.closest('tr').dataset.id)); })); }
    function updateTotalsAndBonuses(mastersEarnings, totalRevenue) { totalRevenueEl.textContent = `${totalRevenue.toFixed(2)} ‚ÇΩ`; serviceShareEl.textContent = `${(totalRevenue * 0.5).toFixed(2)} ‚ÇΩ`; mastersDetailsEl.innerHTML = ''; let totalPayout = 0; const sortedMasters = Object.keys(mastersEarnings).sort(); if (sortedMasters.length === 0) { mastersDetailsEl.innerHTML = `<div class="master-detail-item">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞</div>`; } sortedMasters.forEach(master => { const selectedDate = dateSelector.value; const bonusKey = `${selectedDate}_${master}`; const savedBonus = allBonuses[bonusKey] || { score: 0, amount: 0 }; const earning = mastersEarnings[master]; const bonusAmount = parseFloat(savedBonus.amount) || 0; const masterTotal = earning + bonusAmount; totalPayout += masterTotal; const detailItem = document.createElement('div'); detailItem.className = 'master-detail-item'; detailItem.innerHTML = `<div class="master-main-info"><span class="master-name">${master}</span><strong>${earning.toFixed(2)} ‚ÇΩ</strong></div><div class="master-bonus-controls"><input type="range" min="0" max="5" value="${savedBonus.score}" step="1" class="bonus-slider"><span class="bonus-slider-value">${savedBonus.score}</span><input type="number" min="0" placeholder="–ë–æ–Ω—É—Å" value="${savedBonus.amount}" class="bonus-amount-input"></div><div class="master-total-payout" id="payout-${bonusKey}"><span>–ö –≤—ã–ø–ª–∞—Ç–µ:</span> ${masterTotal.toFixed(2)} ‚ÇΩ</div>`; mastersDetailsEl.appendChild(detailItem); const slider = detailItem.querySelector('.bonus-slider'); const sliderValue = detailItem.querySelector('.bonus-slider-value'); const amountInput = detailItem.querySelector('.bonus-amount-input'); slider.addEventListener('input', () => { sliderValue.textContent = slider.value; allBonuses[bonusKey] = { ...allBonuses[bonusKey], score: slider.value }; saveToStorage(); }); amountInput.addEventListener('input', () => { const newBonusAmount = parseFloat(amountInput.value) || 0; allBonuses[bonusKey] = { ...allBonuses[bonusKey], amount: newBonusAmount }; saveToStorage(); const newTotalPayout = earning + newBonusAmount; document.getElementById(`payout-${bonusKey}`).innerHTML = `<span>–ö –≤—ã–ø–ª–∞—Ç–µ:</span> ${newTotalPayout.toFixed(2)} ‚ÇΩ`; updateTotalPayout(); }); }); updateTotalPayout(); }
    function updateTotalPayout() { const selectedDate = dateSelector.value; const entriesForDay = allEntries.filter(entry => entry.date === selectedDate); let mastersEarnings = {}; entriesForDay.forEach(e => { const earning = (e.workCost + e.partsMarkup) * 0.5; mastersEarnings[e.master] = (mastersEarnings[e.master] || 0) + earning; }); let totalPayout = 0; Object.keys(mastersEarnings).forEach(master => { const bonusKey = `${selectedDate}_${master}`; const bonusAmount = parseFloat(allBonuses[bonusKey]?.amount || 0); totalPayout += mastersEarnings[master] + bonusAmount; }); mastersShareTotalEl.textContent = `${totalPayout.toFixed(2)} ‚ÇΩ`; }
    function saveToStorage() { localStorage.setItem(STORAGE_KEY_ENTRIES, JSON.stringify(allEntries)); localStorage.setItem(STORAGE_KEY_BONUSES, JSON.stringify(allBonuses)); }
    function loadFromStorage() { const savedEntries = localStorage.getItem(STORAGE_KEY_ENTRIES); if (savedEntries) allEntries = JSON.parse(savedEntries); const savedBonuses = localStorage.getItem(STORAGE_KEY_BONUSES); if (savedBonuses) allBonuses = JSON.parse(savedBonuses); }
    // --- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ---
    function generateAnalytics() { const [startDate, endDate] = getPeriodDates(periodSelect.value); if (!startDate || !endDate) return; const periodEntries = allEntries.filter(entry => { const entryDate = new Date(entry.date); return entryDate >= startDate && entryDate <= endDate; }); const totalRevenue = periodEntries.reduce((sum, e) => sum + e.workCost + e.partsMarkup, 0); const totalProfit = totalRevenue * 0.5; const totalPayout = periodEntries.reduce((sum, e) => { const base = (e.workCost + e.partsMarkup) * 0.5; const bonus = parseFloat(allBonuses[`${e.date}_${e.master}`]?.amount || 0); return sum + base + bonus; }, 0); kpiRevenue.textContent = `${totalRevenue.toFixed(0)} ‚ÇΩ`; kpiProfit.textContent = `${totalProfit.toFixed(0)} ‚ÇΩ`; kpiPayout.textContent = `${totalPayout.toFixed(0)} ‚ÇΩ`; kpiJobs.textContent = periodEntries.length; const revenueByDay = {}; for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) { revenueByDay[new Date(d).toISOString().slice(0, 10)] = 0; } periodEntries.forEach(e => { revenueByDay[e.date] = (revenueByDay[e.date] || 0) + e.workCost + e.partsMarkup; }); const mastersContribution = periodEntries.reduce((acc, e) => { const revenue = e.workCost + e.partsMarkup; acc[e.master] = (acc[e.master] || 0) + revenue; return acc; }, {}); drawRevenueByDayChart(revenueByDay); drawMastersContributionChart(mastersContribution); }
    function drawRevenueByDayChart(data) { if (revenueChart) revenueChart.destroy(); revenueChart = new Chart(revenueChartCtx, { type: 'bar', data: { labels: Object.keys(data).map(d => new Date(d).toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'})), datasets: [{ label: '–í—ã—Ä—É—á–∫–∞', data: Object.values(data), backgroundColor: 'rgba(0, 123, 255, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } } } }); }
    function drawMastersContributionChart(data) { if (mastersChart) mastersChart.destroy(); const sortedMasters = Object.entries(data).sort((a,b) => b[1] - a[1]); mastersChart = new Chart(mastersChartCtx, { type: 'doughnut', data: { labels: sortedMasters.map(item => item[0]), datasets: [{ label: '–í–∫–ª–∞–¥', data: sortedMasters.map(item => item[1]), backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d'], }] } }); }
    function getPeriodDates(periodValue) { const today = new Date(); today.setHours(0,0,0,0); let startDate, endDate = new Date(today); switch(periodValue) { case 'this_week': startDate = new Date(today); startDate.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1)); break; case 'last_week': endDate = new Date(today); endDate.setDate(today.getDate() - (today.getDay() === 0 ? 7 : today.getDay())); startDate = new Date(endDate); startDate.setDate(endDate.getDate() - 6); break; case 'this_month': startDate = new Date(today.getFullYear(), today.getMonth(), 1); break; case 'last_month': endDate = new Date(today.getFullYear(), today.getMonth(), 0); startDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1); break; case 'custom': startDate = new Date(startDateInput.value); endDate = new Date(endDateInput.value); if(isNaN(startDate) || isNaN(endDate)) return [null, null]; break; default: return [null, null]; } return [startDate, endDate]; }
    function exportToCsv() { const [startDate, endDate] = getPeriodDates(periodSelect.value); if (!startDate || !endDate) return; const periodEntries = allEntries.filter(entry => { const entryDate = new Date(entry.date); return entryDate >= startDate && entryDate <= endDate; }); if (periodEntries.length === 0) { alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.'); return; } let csvContent = "data:text/csv;charset=utf-8,"; const headers = ["ID", "–î–∞—Ç–∞", "–ú–∞—Å—Ç–µ—Ä", "–ê–≤—Ç–æ–º–æ–±–∏–ª—å", "–û–ø–∏—Å–∞–Ω–∏–µ", "–°—É–º–º–∞ –∑–∞ —Ä–∞–±–æ—Ç—É", "–ù–∞–∫—Ä—É—Ç–∫–∞", "–ò—Ç–æ–≥–æ"]; csvContent += headers.join(",") + "\r\n"; periodEntries.forEach(e => { const row = [e.id, e.date, e.master, `"${e.car.replace(/"/g, '""')}"`, `"${e.description.replace(/"/g, '""')}"`, e.workCost, e.partsMarkup, e.workCost + e.partsMarkup]; csvContent += row.join(",") + "\r\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `report_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
});
</script>

</body>
</html>